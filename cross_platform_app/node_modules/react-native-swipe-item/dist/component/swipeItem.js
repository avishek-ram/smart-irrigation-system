var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _react=_interopRequireDefault(require("react"));var _reactNative=require("react-native");var _swipeButtonsContainer=_interopRequireDefault(require("./swipeButtonsContainer"));var _swipeContext=require("./swipeContext");var _jsxFileName="/Users/wangyungyi/GitProject/react-native-swipe-item/src/component/swipeItem.js";function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=(0,_getPrototypeOf2.default)(Derived),result;if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2.default)(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return(0,_possibleConstructorReturn2.default)(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}var SwipeItem=function(_React$Component){(0,_inherits2.default)(SwipeItem,_React$Component);var _super=_createSuper(SwipeItem);function SwipeItem(props){var _this;(0,_classCallCheck2.default)(this,SwipeItem);_this=_super.call(this,props);_this._swipeItem=(0,_assertThisInitialized2.default)(_this);_this._panDistanceOffset={x:0,y:0};_this._isRightButtonShowing=false;_this._isLeftButtonShowing=false;_this._isGestureDisabled=false;_this.state={panDistance:new _reactNative.Animated.ValueXY(),rightButtonTriggerPosition:0,leftButtonTriggerPosition:0};_this._panResponder=_this._createPanResponderInstance();_this.state.panDistance.addListener(function(value){_this._panDistanceOffset=value;});return _this;}(0,_createClass2.default)(SwipeItem,[{key:"componentWillUnmount",value:function componentWillUnmount(){this.context&&this.context.removeOpenedItemRef(this);this.state.panDistance.removeAllListeners();}},{key:"_createPanResponderInstance",value:function _createPanResponderInstance(){var _this2=this;var instance=_reactNative.PanResponder.create({onMoveShouldSetPanResponderCapture:function onMoveShouldSetPanResponderCapture(evt,gestureState){if(Math.abs(gestureState.dx)<5){return false;}if(_this2.props.disableSwipeIfNoButton){if(!_this2.props.leftButtons&&gestureState.dx>0&&!_this2._isRightButtonShowing||!_this2.props.rightButtons&&gestureState.dx<0&&!_this2._isLeftButtonShowing){return false;}}_this2._isGestureDisabled=false;var offsetX=_this2._panDistanceOffset.x;if(Math.round(offsetX)===0){_this2.props.onSwipeInitial&&_this2.props.onSwipeInitial(_this2._swipeItem);_this2.context&&_this2.context.setOpenedItemRef(_this2,'onItemMoved');}return true;},onPanResponderGrant:function onPanResponderGrant(evt,gestureState){_this2.state.panDistance.setOffset(_this2._panDistanceOffset);_this2.state.panDistance.setValue({x:0,y:0});},onPanResponderMove:function onPanResponderMove(evt,gestureState){if(_this2._isGestureDisabled){return;}var _this2$props$swipeThr=_this2.props.swipeThreshold,swipeThreshold=_this2$props$swipeThr===void 0?{right:Infinity,left:Infinity}:_this2$props$swipeThr;var dx=gestureState.dx;if(dx>0&&dx>swipeThreshold.left&&dx<_this2.state.leftButtonTriggerPosition&&!_this2._isLeftButtonShowing){_this2._isGestureDisabled=true;_reactNative.Animated.spring(_this2.state.panDistance,{useNativeDriver:false,toValue:{x:_this2.state.leftButtonTriggerPosition,y:0}}).start();_this2._openLeftButton();return;}if(dx<0&&Math.abs(dx)>swipeThreshold.right&&Math.abs(dx)<Math.abs(_this2.state.rightButtonTriggerPosition)&&!_this2._isRightButtonShowing){_this2._isGestureDisabled=true;_reactNative.Animated.spring(_this2.state.panDistance,{useNativeDriver:false,toValue:{x:_this2.state.rightButtonTriggerPosition,y:0}}).start();_this2._openRightButton();return;}_reactNative.Animated.event([null,{dx:_this2.state.panDistance.x}],{useNativeDriver:false})(evt,gestureState);},onPanResponderRelease:function onPanResponderRelease(evt,gestureState){if(!_this2._isGestureDisabled){_this2._moveToDestination(_this2._getSwipePositionDestinationValueX(gestureState.dx));}},onPanResponderTerminate:function onPanResponderTerminate(evt,gestureState){if(!_this2._isGestureDisabled){_this2._moveToDestination(_this2._getSwipePositionDestinationValueX(gestureState.dx));}return true;},onPanResponderTerminationRequest:function onPanResponderTerminationRequest(evt,gestureState){if(_reactNative.Platform.OS==='android'){return true;}return false;}});return instance;}},{key:"_moveToDestination",value:function _moveToDestination(toX){if(Math.round(toX)===0){this._isLeftButtonShowing=false;this._isRightButtonShowing=false;this.context&&this.context.removeOpenedItemRef(this);this.props.onMovedToOrigin&&this.props.onMovedToOrigin(this._swipeItem);}this.state.panDistance.flattenOffset();_reactNative.Animated.spring(this.state.panDistance,{useNativeDriver:false,toValue:{x:toX,y:0},friction:10}).start();}},{key:"close",value:function close(){this._moveToDestination(0);}},{key:"_openRightButton",value:function _openRightButton(){this._isRightButtonShowing=true;this.props.onRightButtonsShowed&&this.props.onRightButtonsShowed(this._swipeItem);this.context&&this.context.setOpenedItemRef(this,'onButtonShowed');}},{key:"_openLeftButton",value:function _openLeftButton(){this._isLeftButtonShowing=true;this.props.onLeftButtonsShowed&&this.props.onLeftButtonsShowed(this._swipeItem);this.context&&this.context.setOpenedItemRef(this,'onButtonShowed');}},{key:"_getSwipePositionDestinationValueX",value:function _getSwipePositionDestinationValueX(panDistanceX){var _this$state=this.state,leftButtonTriggerPosition=_this$state.leftButtonTriggerPosition,rightButtonTriggerPosition=_this$state.rightButtonTriggerPosition;var toValueX=0;var panSide=panDistanceX>0?'right':'left';var containerOffset=this._panDistanceOffset.x;if(panSide==='right'&&containerOffset>leftButtonTriggerPosition&&!!this.props.leftButtons){toValueX=leftButtonTriggerPosition;this._openLeftButton();}if(panSide==='left'&&containerOffset<rightButtonTriggerPosition&&!!this.props.rightButtons){toValueX=rightButtonTriggerPosition;this._openRightButton();}return toValueX;}},{key:"_renderleftButtonsIfNotNull",value:function _renderleftButtonsIfNotNull(){var _this3=this;var _this$props=this.props,_this$props$leftButto=_this$props.leftButtons,leftButtons=_this$props$leftButto===void 0?null:_this$props$leftButto,_this$props$disableBu=_this$props.disableButtonScale,disableButtonScale=_this$props$disableBu===void 0?{left:false}:_this$props$disableBu;var leftButtonTriggerPosition=this.state.leftButtonTriggerPosition;if(leftButtons==null){return null;}var _leftButtons$props=leftButtons.props,style=_leftButtons$props.style,children=_leftButtons$props.children;var scale=disableButtonScale.left?1:this.state.panDistance.x.interpolate({inputRange:[-Infinity,-0.01,0,leftButtonTriggerPosition,Infinity],outputRange:[0.01,0.01,0.7,1,1]});var widthStyle={transform:[{scale:scale}]};return _react.default.createElement(_swipeButtonsContainer.default,{style:[style,buttonViewStyles.container,buttonViewStyles.left,widthStyle],onLayout:function onLayout(_ref){var nativeEvent=_ref.nativeEvent;_this3.setState({leftButtonTriggerPosition:nativeEvent.layout.width});},__self:this,__source:{fileName:_jsxFileName,lineNumber:273,columnNumber:13}},children);}},{key:"_renderrightButtonsIfNotNull",value:function _renderrightButtonsIfNotNull(){var _this4=this;var _this$props2=this.props,_this$props2$rightBut=_this$props2.rightButtons,rightButtons=_this$props2$rightBut===void 0?null:_this$props2$rightBut,_this$props2$disableB=_this$props2.disableButtonScale,disableButtonScale=_this$props2$disableB===void 0?{right:false}:_this$props2$disableB;var rightButtonTriggerPosition=this.state.rightButtonTriggerPosition;if(rightButtons==null){return null;}var _rightButtons$props=rightButtons.props,style=_rightButtons$props.style,children=_rightButtons$props.children;var scale=disableButtonScale.right?1:this.state.panDistance.x.interpolate({inputRange:[-Infinity,rightButtonTriggerPosition,0,0.1,Infinity],outputRange:[1,1,0.7,0.01,0.01]});var widthStyle={transform:[{scale:scale}]};return _react.default.createElement(_swipeButtonsContainer.default,{style:[style,buttonViewStyles.container,buttonViewStyles.right,widthStyle],onLayout:function onLayout(_ref2){var nativeEvent=_ref2.nativeEvent;_this4.setState({rightButtonTriggerPosition:-1*nativeEvent.layout.width});},__self:this,__source:{fileName:_jsxFileName,lineNumber:309,columnNumber:13}},children);}},{key:"render",value:function render(){var panStyle={transform:this.state.panDistance.getTranslateTransform()};var _this$props3=this.props,style=_this$props3.style,swipeContainerStyle=_this$props3.swipeContainerStyle,_this$props3$containe=_this$props3.containerView,ContainerView=_this$props3$containe===void 0?_reactNative.View:_this$props3$containe;return _react.default.createElement(_reactNative.View,{__self:this,__source:{fileName:_jsxFileName,lineNumber:330,columnNumber:13}},_react.default.createElement(ContainerView,{style:[style,containerStyles.rootContainer],__self:this,__source:{fileName:_jsxFileName,lineNumber:331,columnNumber:17}},_react.default.createElement(_reactNative.View,{style:[containerStyles.buttonsContainer],__self:this,__source:{fileName:_jsxFileName,lineNumber:332,columnNumber:21}},this._renderleftButtonsIfNotNull(),this._renderrightButtonsIfNotNull()),_react.default.createElement(_reactNative.Animated.View,(0,_extends2.default)({style:[containerStyles.swipeContainer,panStyle]},this._panResponder.panHandlers,{__self:this,__source:{fileName:_jsxFileName,lineNumber:336,columnNumber:21}}),_react.default.createElement(_reactNative.View,{style:[swipeContainerStyle,containerStyles.swipeContainer],__self:this,__source:{fileName:_jsxFileName,lineNumber:340,columnNumber:25}},this.props.children))));}}]);return SwipeItem;}(_react.default.Component);exports.default=SwipeItem;SwipeItem.contextType=_swipeContext.SwipeContext;var containerStyles=_reactNative.StyleSheet.create({rootContainer:{flexDirection:_reactNative.I18nManager.isRTL?'row-reverse':'row',justifyContent:'center'},buttonsContainer:{height:'100%',width:'100%',position:'absolute',flexDirection:_reactNative.I18nManager.isRTL?'row-reverse':'row',top:0,left:0},swipeContainer:{height:'100%',width:'100%'}});var buttonViewStyles=_reactNative.StyleSheet.create({container:{position:'absolute'},left:{left:0},right:{right:0}});